---
title: "SuSiE"
author: "Xinyu Guo"
date: "5/7/2021"
output: html_document
---

## Load some packages
```{r}
#devtools::install_github("stephenslab/susieR")
library(susieR)
library(tidyverse)
```

## get familiar with the package
```{r}
data(N3finemapping)
attach(N3finemapping)
dim(Y)
b <- true_coef[,1]
plot(b, pch=16, ylab='effect size')
which(b != 0)
sumstats <- univariate_regression(X, Y[,1])
z_scores <- sumstats$betahat / sumstats$sebetahat
susie_plot(z_scores, y = "z", b=b)
R <- cor(X)
fitted_rss <- susie_rss(z_scores, R, L = 10)
summary(fitted_rss)$cs
susie_plot(fitted_rss, y="PIP", b=b)
```

## Load data
```{r}
load("./ad_TWAS.RData")
load("./cov_matrix.RData")
head(dat_ad_n[[1]])
length(cov_matrix)
dat_ad <- dat_ad_n[[1]]
all_gene <- dat_ad$GENE
# sort complete data
dat_ad_complete <- dat_ad %>% 
  drop_na()
gene <- "CCAR1"
dat_susie <- dat_ad_complete %>% 
  filter(GENE == gene)
dat_input <- as.numeric(dat_susie[, -1])
cor_matrix <- cov2cor(cov_matrix[[gene]])
fitted_rss <- susie_rss(dat_input, cor_matrix, L = 3)
fitted_rss
```

## Run SuSiE
```{r}
run_susie <- function(gene, data, cov_matrix, l = 3){
  dat_gene <- data %>% 
    filter(GENE == gene) %>% 
    select_if(!is.na(.))
  dat_gene <- dat_gene[, -1]
  dat_gene <- dat_gene[, is.finite(as.numeric(dat_gene))] # check finite
  cov_gene <- cov_matrix[[gene]]
  if(ncol(dat_gene) >= ncol(cov_gene)){
    dat_gene = dat_gene %>% select(gsub("\\.", "-", rownames(cov_gene)))
  }
  else{
    cov_gene = cov_gene[gsub("-", "\\.", names(dat_gene)), gsub("-", "\\.", names(dat_gene))]
  }
  dat_input <- as.numeric(dat_gene)
  fitted_rss <- susie_rss(dat_input, cov_gene, L = l)
  vars <- names(dat_gene)
  out <- list(fitted_rss, vars)
  return(out)
}

# res <- run_susie("EXOC3L2", dat_ad, cov_matrix, 4)

all_res <- data.frame()
for (gene in all_gene) {
  res <- run_susie(gene, dat_ad, cov_matrix, 4)
  nms <- res[[2]]
  smy <- summary(res[[1]])
  tem_out <- smy$vars %>% 
    mutate(tissues = nms[smy$vars$variable], 
           GENE = gene) %>% 
    filter(cs > 0) %>% 
    select(-variable)
  all_res <- rbind(all_res, tem_out)
}
```


##Go through all data to see whether there is non-null cs

```{r}
dat_ad <- dat_ad_n[[2]]
all_gene <- dat_ad$GENE
#Here I use all data

dat_ad_complete <- dat_ad

i=0
for(gene in dat_ad_complete$GENE){
  
  #check out print
  i=i+1
  if(i%%100==0){
    print(paste('check',i,gene,sep='-'))
    print(summary(fitted_rss)$cs)
  }
  
  #take out gene of interested
  dat_susie <- dat_ad_complete %>% filter(GENE == gene)
  dat_input <- dat_susie[, -1]
  
  #take index for non-na data
  index = which(!is.na(dat_input))
  no.na.col = colnames(dat_input)[index]
  
  #take corresponding cor.matrix 
  cor_matrix <- cov2cor(cov_matrix[[gene]])
  cor.col = colnames(cor_matrix)
  
  #take the intersection of col between data and cor.matrix to make them same length 
  col.choose = no.na.col[which(no.na.col %in% cor.col)]
  
  cor_matrix = cor_matrix[col.choose,col.choose]
  dat_input = dat_input[,col.choose]
  
  #ignore data with few characters, one can modify the threshold
  if(length(col.choose)<=1){
    next
   }
  
  #fit model
  fitted_rss <- susie_rss(as.numeric(dat_input), cor_matrix, L = 3)
  
  if(!is.null(summary(fitted_rss)$cs)){
    print(gene)
    print(summary(fitted_rss)$cs)
  }
}
```

The results is that all of them are null. I will check for dat_ad <- dat_ad_n[[1]] later

For dat_ad <- dat_ad_n[[1]], we have many of them with non-na cs

```{r}
dat_ad <- dat_ad_n[[1]]
dat_ad_complete <- dat_ad %>% 
  drop_na()
all_gene <- dat_ad$GENE
#Here I use all data

dat_ad_complete <- dat_ad

i=0
for(gene in dat_ad_complete$GENE){
  
  #check out print
  i=i+1
  if(i%%100==0){
    print(paste('check',i,gene,sep='-'))
    print(summary(fitted_rss)$cs)
  }
  
  #take out gene of interested
  dat_susie <- dat_ad_complete %>% filter(GENE == gene)
  dat_input <- dat_susie[, -1]
  
  #take index for non-na data
  index = which(!is.na(dat_input))
  no.na.col = colnames(dat_input)[index]
  
  #take corresponding cor.matrix 
  cor_matrix <- cov2cor(cov_matrix[[gene]])
  cor.col = colnames(cor_matrix)
  
  #take the intersection of col between data and cor.matrix to make them same length 
  col.choose = no.na.col[which(no.na.col %in% cor.col)]
  
  cor_matrix = cor_matrix[col.choose,col.choose]
  dat_input = dat_input[,col.choose]
  
  #ignore data with few characters, one can modify the threshold
  if(length(col.choose)<=1){
    next
   }
  
  #fit model
  fitted_rss <- susie_rss(as.numeric(dat_input), cor_matrix, L = 3)
  
  if(!is.null(summary(fitted_rss)$cs)){
    print(gene)
    print(summary(fitted_rss)$cs)
  }
}
```


















